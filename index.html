<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íœ˜ë§¤ì“° DB</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #4CAF50;
      color: white;
      text-align: center;
      padding: 1em 0;
    }
    main {
      padding: 20px;
    }
    .filter-section {
      margin: 20px 0;
      text-align: center;
    }
    .filter-section input {
      padding: 5px;
      margin-left: 5px;
    }
    #game-details {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    table th:nth-child(3),
    table td:nth-child(3) {
      width: 90px;
    }
    table th {
      background-color: #f2f2f2;
    }
    .export-button {
      margin-top: 20px;
      text-align: center;
    }
    .export-button button {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-button button:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background-color: #ff0000;
    }
  </style>
  <script defer>
    let gameData = [];
    let userData = [];
    let selectedGame = '';
    let selectedUser = '';
    let selectedStartDate = '';  // ì‹œì‘ ë‚ ì§œ
    let selectedEndDate = '';    // ì¢…ë£Œ ë‚ ì§œ

    // ì •ë ¬ìš© ì „ì—­ ë³€ìˆ˜
    let sortKey = '';
    let sortDirection = 'desc'; // ê¸°ë³¸ ë‚´ë¦¼ì°¨ìˆœ

    // âœ… ê²Œì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchGameData(page = 1, pageSize = 1000000) {
      try {
        const response = await fetch(`https://us-central1-record-f420d.cloudfunctions.net/getGameData?page=${page}&pageSize=${pageSize}`);
        const result = await response.json();
        console.log('ê²Œì„ API ì‘ë‹µ:', result);

        if (result.data && Array.isArray(result.data)) {
          gameData = result.data;
          renderFilteredDetails();
        } else {
          console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ê²Œì„ ë°ì´í„° í˜•ì‹ ë°˜í™˜:', result);
        }
      } catch (error) {
        console.error('ê²Œì„ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
      }
    }

    // âœ… ê²Œì„/ì‚¬ìš©ì ì…ë ¥ í•¸ë“¤ëŸ¬
    function handleGameInput() {
      selectedGame = document.getElementById('game-input').value;
      renderFilteredDetails();
    }

    function handleUserInput() {
      selectedUser = document.getElementById('user-input').value;
      renderFilteredDetails();
    }

    // âœ… ë‚ ì§œ ë²”ìœ„ ì„ íƒ í•¸ë“¤ëŸ¬
    function handleDateRange() {
      selectedStartDate = document.getElementById('start-date').value;
      selectedEndDate = document.getElementById('end-date').value;
      renderFilteredDetails();
    }

    // âœ… ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function sortData(key, direction = 'desc') {
      sortKey = key;
      sortDirection = direction;
      renderFilteredDetails();  // ì •ë ¬ í›„ ë‹¤ì‹œ ë Œë”ë§
    }

    // âœ… í•„í„°ë§ ë° ë Œë”ë§
    function renderFilteredDetails() {
      let filteredData = gameData;

      // ê²Œì„, ì‚¬ìš©ì í•„í„°ë§
      if (selectedGame) {
        filteredData = filteredData.filter(item => item.game === selectedGame);
      }
      if (selectedUser) {
        filteredData = filteredData.filter(item => item.name === selectedUser);
      }

      // ë‚ ì§œ í•„í„°ë§
      if (selectedStartDate) {
        filteredData = filteredData.filter(item => new Date(item.timestamp) >= new Date(selectedStartDate));
      }
      if (selectedEndDate) {
        filteredData = filteredData.filter(item => new Date(item.timestamp) <= new Date(selectedEndDate));
      }

      // ì •ë ¬ ë¡œì§
      if (sortKey) {
        filteredData.sort((a, b) => {
          let aVal, bVal;

          switch (sortKey) {
            case 'game':
              aVal = a.game;
              bVal = b.game;
              break;
            case 'name':
              aVal = a.name;
              bVal = b.name;
              break;
            case 'timePerProblem':
              const aTime = (Number(a.elapsedTime) / Number(a.score)) * 10 || 0;
              const bTime = (Number(b.elapsedTime) / Number(b.score)) * 10 || 0;
              aVal = aTime;
              bVal = bTime;
              break;
            case 'timestamp':
              aVal = a.timestamp;
              bVal = b.timestamp;
              break;
            default:
              aVal = a[sortKey];
              bVal = b[sortKey];
              break;
          }

          // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
          if (sortDirection === 'desc') {
            if (aVal > bVal) return -1;
            if (aVal < bVal) return 1;
            return 0;
          } else {
            // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            if (aVal < bVal) return -1;
            if (aVal > bVal) return 1;
            return 0;
          }
        });
      }

      const tbody = document.getElementById('data-body');
      tbody.innerHTML = '';

      filteredData.forEach((item) => {
        const tr = document.createElement('tr');

        const gameTd = document.createElement('td');
        const gameLink = document.createElement('a');
        gameLink.href = "#";
        gameLink.textContent = item.game;
        gameLink.onclick = function() { goToGame(item.game); };
        gameTd.appendChild(gameLink);

        const nameTd = document.createElement('td');
        const nameLink = document.createElement('a');
        nameLink.href = "#";
        nameLink.textContent = item.name;
        nameLink.onclick = function() { goToUser(item.name); };
        nameTd.appendChild(nameLink);

        const scoreTd = document.createElement('td');
        scoreTd.innerText = item.score;

        const elapsedTimeTd = document.createElement('td');
        elapsedTimeTd.innerText = item.elapsedTime;

        const timestampTd = document.createElement('td');
        timestampTd.innerText = new Date(item.timestamp).toLocaleString();

        const deleteTd = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.innerText = 'X';
        deleteBtn.classList.add('delete-btn');
        deleteTd.appendChild(deleteBtn);

        tr.appendChild(gameTd);
        tr.appendChild(nameTd);
        tr.appendChild(scoreTd);
        tr.appendChild(elapsedTimeTd);
        tr.appendChild(timestampTd);
        tr.appendChild(deleteTd);

        tbody.appendChild(tr);
      });
    }

    // âœ… ê²Œì„ í´ë¦­ ì‹œ í•„í„°ë§ í•¨ìˆ˜
    function goToGame(game) {
      selectedGame = game;
      document.getElementById('game-input').value = game;
      selectedUser = '';
      document.getElementById('user-input').value = '';
      renderFilteredDetails();
    }

    // âœ… ì‚¬ìš©ì í´ë¦­ ì‹œ í•„í„°ë§ í•¨ìˆ˜
    function goToUser(name) {
      selectedUser = name;
      document.getElementById('user-input').value = name;
      selectedGame = '';
      document.getElementById('game-input').value = '';
      renderFilteredDetails();
    }

    window.onload = () => {
      fetchGameData();
    };
  </script>
</head>
<body>
  <header>
    <h1>ğŸ® ê²Œì„ ë° ì‚¬ìš©ì ë°ì´í„° ëŒ€ì‹œë³´ë“œ</h1>
  </header>
  <main>
    <section class="filter-section">
      <label for="game-input">ê²Œì„ ì„ íƒ:</label>
      <input type="text" id="game-input" list="game-list" oninput="handleGameInput()">
      <datalist id="game-list"></datalist>

      <label for="user-input">ì‚¬ìš©ì ì„ íƒ:</label>
      <input type="text" id="user-input" list="user-list" oninput="handleUserInput()">
      <datalist id="user-list"></datalist>

      <!-- ë‚ ì§œ ë²”ìœ„ ì„ íƒ -->
      <label for="start-date">ì‹œì‘ ë‚ ì§œ:</label>
      <input type="date" id="start-date" onchange="handleDateRange()">
      <label for="end-date">ì¢…ë£Œ ë‚ ì§œ:</label>
      <input type="date" id="end-date" onchange="handleDateRange()">
    </section>

    <section id="game-details">
      <h2>ë°ì´í„° ìƒì„¸ ì •ë³´</h2>
      <table>
        <thead>
          <tr>
            <th>
              ê²Œì„ 
              <button onclick="sortData('game', 'desc')">â–¼</button>
            </th>
            <th>
              ì´ë¦„ 
              <button onclick="sortData('name', 'desc')">â–¼</button>
            </th>
            <th>ì ìˆ˜</th>
            <th>ê²½ê³¼ì‹œê°„</th>
            <th>
              ë¬¸ì œë‹¹ ì†Œìš”ì‹œê°„ 
              <button onclick="sortData('timePerProblem', 'desc')">â–¼</button>
            </th>
            <th>
              Timestamp 
              <button onclick="sortData('timestamp', 'desc')">â–¼</button>
            </th>
            <th>ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="data-body"></tbody>
      </table>
    </section>
  </main>
</body>
</html>
